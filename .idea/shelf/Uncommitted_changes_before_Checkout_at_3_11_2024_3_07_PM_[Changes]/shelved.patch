Index: example/modeler.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>/* global process */\r\n\r\n'use strict'; \r\nimport $ from 'jquery';\r\nimport TokenSimulationModule from '..';\r\n//import BpmnColorPickerModule from 'bpmn-js-color-picker';\r\n//import BpmnModeler from 'bpmn-js/lib/Modeler';\r\n\r\nimport AddExporter from '@bpmn-io/add-exporter';\r\nimport {\r\n  BpmnPropertiesPanelModule,\r\n  BpmnPropertiesProviderModule\r\n} from 'bpmn-js-properties-panel';\r\n\r\n//import spacePropertiesProviderModule from './lib/spacePropertiesPanel/spacePropertiesProvider/index.js';\r\n//import spaceModdleDescriptor from './lib/spacePropertiesPanel/descriptors/space.json';\r\n\r\nimport fileDrop from 'file-drops';\r\n\r\nimport fileOpen from 'file-open';\r\n\r\nimport download from 'downloadjs';\r\nimport Zip from 'jszip';\r\n\r\nimport exampleXML from '../example/resources/prova.bpmn';\r\n\r\nimport OlcModeler from './lib/olcmodeler/OlcModeler';\r\nimport Mediator from './lib/mediator/Mediator';\r\nimport BpmnSpaceModeler from './lib/bpmnmodeler/bpmnSpaceModeler';\r\nimport { downloadZIP, uploadZIP } from './lib/util/FileUtil';\r\n\r\nconst url = new URL(window.location.href);\r\nconst persistent = url.searchParams.has('p');\r\nconst active = url.searchParams.has('e');\r\nconst presentationMode = url.searchParams.has('pm');\r\n\r\n\r\nlet fileName = 'diagram.bpmn';\r\n\r\nconst initialDiagram = (() => {\r\n  try {\r\n    return persistent && localStorage['diagram-xml'] || exampleXML;\r\n  } catch (err) {\r\n    return exampleXML;\r\n  }\r\n})();\r\n\r\nfunction showMessage(cls, message) {\r\n  const messageEl = document.querySelector('.drop-message');\r\n\r\n  messageEl.textContent = message;\r\n  messageEl.className = `drop-message ${cls || ''}`;\r\n\r\n  messageEl.style.display = 'block';\r\n}\r\n\r\nfunction hideMessage() {\r\n  const messageEl = document.querySelector('.drop-message');\r\n\r\n  messageEl.style.display = 'none';\r\n}\r\n\r\nif (persistent) {\r\n  hideMessage();\r\n}\r\n\r\n/*const ExampleModule = {\r\n  __init__: [\r\n    [ 'eventBus', 'bpmnjs', 'toggleMode', function(eventBus, bpmnjs, toggleMode) {\r\n\r\n      if (persistent) {\r\n        eventBus.on('commandStack.changed', function() {\r\n          bpmnjs.saveXML().then(result => {\r\n            localStorage['diagram-xml'] = result.xml;\r\n          });\r\n        });\r\n      }\r\n\r\n      if ('history' in window) {\r\n        eventBus.on('tokenSimulation.toggleMode', event => {\r\n\r\n          document.body.classList.toggle('token-simulation-active', event.active);\r\n\r\n          if (event.active) {\r\n            url.searchParams.set('e', '1');\r\n          } else {\r\n            url.searchParams.delete('e');\r\n          }\r\n\r\n          history.replaceState({}, document.title, url.toString());\r\n        });\r\n      }\r\n\r\n      eventBus.on('diagram.init', 500, () => {\r\n        toggleMode.toggleMode(active);\r\n      });\r\n    } ]\r\n  ]\r\n};*/\r\n\r\nvar mediator = new Mediator();\r\nwindow.mediator = mediator;\r\n\r\n//modeler for space\r\nvar olcModeler = new OlcModeler({\r\n    container: document.querySelector('#olc-canvas'),\r\n    keyboard: { \r\n      bindTo: document.querySelector('#olc-canvas') \r\n    },\r\n    additionalModules: [{\r\n      __init__ : ['mediator'],\r\n      mediator : ['type', mediator.OlcModelerHook]\r\n    }\r\n  ]\r\n});\r\n\r\n//create a bpmn modeler\r\nvar modeler = new BpmnSpaceModeler({\r\n  container:'#canvas',\r\n  keyboard: { \r\n    bindTo: document \r\n  },\r\n  exporter: {\r\n    name: 'bpmn-js-token-simulation',\r\n    version: process.env.TOKEN_SIMULATION_VERSION\r\n  },\r\n  additionalModules: [{\r\n    __init__ : ['mediator'],\r\n    mediator : ['type', mediator.SpaceModelerHook]\r\n  },\r\n  // BpmnPropertiesPanelModule,\r\n  // BpmnPropertiesProviderModule,\r\n  TokenSimulationModule,\r\n  //BpmnColorPickerModule,\r\n  AddExporter,\r\n // ExampleModule\r\n      \r\n],\r\n  propertiesPanel: {\r\n    parent: '#properties-panel'\r\n  }\r\n});\r\n\r\n//all'inizio il time-execution non deve comparire, compare solo con il toggle\r\n//document.querySelector(\"#time-execution\").style.display = \"none\";\r\n\r\n//Serve per creare gli XML dei due modeler\r\nasync function createNewDiagram() {\r\n    await modeler.importXML(exampleXML);\r\n    await olcModeler.createNew(); //inizializza XML dell'olc modeler\r\n}\r\n\r\n$(function() {\r\n  createNewDiagram();\r\n});\r\n\r\n\r\nfunction openDiagram(diagram) {\r\n  return modeler.importXML(diagram)\r\n    .then(({ warnings }) => {\r\n      if (warnings.length) {\r\n        console.warn(warnings);\r\n      }\r\n\r\n      if (persistent) {\r\n        localStorage['diagram-xml'] = diagram;\r\n      }\r\n\r\n      modeler.get('canvas').zoom('fit-viewport');\r\n    })\r\n    .catch(err => {\r\n      console.error(err);\r\n    });\r\n}\r\n\r\nif (presentationMode) {\r\n  document.body.classList.add('presentation-mode');\r\n}\r\n\r\nfunction openFile(files) {\r\n\r\n  // files = [ { name, contents }, ... ]\r\n\r\n  if (!files.length) {\r\n    return;\r\n  }\r\n\r\n  hideMessage();\r\n\r\n  fileName = files[0].name;\r\n\r\n  openDiagram(files[0].contents);\r\n}\r\n\r\ndocument.body.addEventListener('dragover', fileDrop('Open BPMN diagram', openFile), false);\r\n\r\n//open diagram\r\nfunction loadDiagram(xml) {\r\n  var fileInput = document.createElement(\"input\");\r\n  document.body.appendChild(fileInput);\r\n\r\n  $(fileInput).attr({ 'type': 'file' }).on('change', function (e) {\r\n      var file = e.target.files[0];\r\n      var reader = new FileReader();\r\n      if (file) {\r\n      reader.readAsText(file, \"UTF-8\");\r\n      reader.onload = function (evt) {\r\n\r\n          var bpmnXML = evt.target.result;\r\n          modeler.importXML(bpmnXML, function(err) {\r\n        if (err) {\r\n          return console.error('could not import BPMN 2.0 diagram', err);\r\n        }\r\n        // access modeler components\r\n        var canvas = modeler.get('canvas');\r\n        var overlays = modeler.get('overlays');\r\n        // zoom to fit full viewport\r\n        canvas.zoom('fit-viewport');\r\n      });\r\n      }\r\n      reader.onerror = function (evt) {\r\n          document.getElementById(\"fileContents\").innerHTML = \"error reading file\";\r\n      }\r\n    }\r\n    }).trigger('click');\r\n    document.body.removeChild(fileInput);\r\n  }\r\n\r\n  async function importFromZip (zipData) {\r\n    const zip = await Zip.loadAsync(zipData, {base64 : true});\r\n    const files = {\r\n      space: zip.file('behaviour.bpmn'),\r\n      olcs: zip.file('space.xml'),\r\n    };\r\n    Object.keys(files).forEach(key => {\r\n      if (!files[key]) {\r\n        throw new Error('Missing file: '+key)\r\n      }\r\n    });\r\n    await olcModeler.importXML(await files.olcs.async(\"string\"));\r\n    await modeler.importXML(await files.space.async(\"string\"));\r\n  }\r\n\r\ndocument.querySelector(\"#open-diagram\").addEventListener('click', () => uploadZIP(data => {\r\n    if (data.startsWith('data:')) {\r\n      data = data.split(',')[1];\r\n    }\r\n    importFromZip(data);\r\n  }, 'base64'));\r\n\r\n//document.querySelector(\"#open-diagram\").addEventListener('click', (e) =>loadDiagram(e.currentTarget.file));\r\n\r\n//download diagram\r\nfunction downloadDiagram() {\r\n  modeler.saveXML({ format: true }, function(err, xml) {\r\n    if (!err) {\r\n      download(xml, fileName, 'application/xml');\r\n    }\r\n  });\r\n}\r\n\r\ndocument.body.addEventListener('keydown', function(event) {\r\n  if (event.code === 'KeyS' && (event.metaKey || event.ctrlKey)) {\r\n    event.preventDefault();\r\n\r\n    downloadDiagram();\r\n  }\r\n\r\n  if (event.code === 'KeyO' && (event.metaKey || event.ctrlKey)) {\r\n    event.preventDefault();\r\n\r\n    fileOpen().then(openFile);\r\n  }\r\n});\r\n\r\nasync function exportToZip () {\r\n  const zip = new Zip();\r\n  const space = (await modeler.saveXML({format:true})).xml;\r\n  zip.file('behaviour.bpmn', space);\r\n  const olcs = (await olcModeler.saveXML({ format: true })).xml;\r\n  zip.file('space.xml', olcs);\r\n  return zip.generateAsync({type : 'base64'}); \r\n}\r\n\r\ndocument.querySelector('#download-button').addEventListener('click',  () => exportToZip().then(zip => {\r\n  downloadZIP('SpaceBPMN.zip', zip, 'base64');\r\n  //importFromZip(zip);\r\n}));\r\n\r\nconst propertiesPanel = document.querySelector('#properties-panel');\r\n\r\nconst propertiesPanelResizer = document.querySelector('#properties-panel-resizer');\r\n\r\nlet startX, startWidth;\r\n\r\nfunction toggleProperties(open) {\r\n\r\n  if (open) {\r\n    url.searchParams.set('pp', '1');\r\n  } else {\r\n    url.searchParams.delete('pp');\r\n  }\r\n\r\n  history.replaceState({}, document.title, url.toString());\r\n\r\n  propertiesPanel.classList.toggle('open', open);\r\n}\r\n\r\npropertiesPanelResizer.addEventListener('click', function(event) {\r\n  toggleProperties(!propertiesPanel.classList.contains('open'));\r\n});\r\n\r\npropertiesPanelResizer.addEventListener('dragstart', function(event) {\r\n  const img = new Image();\r\n  img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';\r\n  event.dataTransfer.setDragImage(img, 1, 1);\r\n\r\n  startX = event.screenX;\r\n  startWidth = propertiesPanel.getBoundingClientRect().width;\r\n});\r\n\r\npropertiesPanelResizer.addEventListener('drag', function(event) {\r\n\r\n  if (!event.screenX) {\r\n    return;\r\n  }\r\n\r\n  const delta = event.screenX - startX;\r\n\r\n  const width = startWidth - delta;\r\n\r\n  const open = width > 200;\r\n\r\n  propertiesPanel.style.width = open ? `${width}px` : null;\r\n\r\n  toggleProperties(open);\r\n});\r\n\r\nconst remoteDiagram = url.searchParams.get('diagram');\r\n\r\n//Apre il diagramma iniziale\r\nif (remoteDiagram) {\r\n  fetch(remoteDiagram).then(\r\n    r => {\r\n      if (r.ok) {\r\n        return r.text();\r\n      }\r\n\r\n      throw new Error(`Status ${r.status}`);\r\n    }\r\n  ).then(\r\n    text => openDiagram(text)\r\n  ).catch(\r\n    err => {\r\n      showMessage('error', `Failed to open remote diagram: ${err.message}`);\r\n\r\n      openDiagram(initialDiagram);\r\n    }\r\n  );\r\n} else {\r\n  openDiagram(initialDiagram);\r\n}\r\n\r\ntoggleProperties(url.searchParams.has('pp'));\r\n\r\n\r\n\r\n// part for dynamism of the  vertical divider \r\nvar dragTarget = undefined;\r\n\r\nwindow.addEventListener('mousemove', function (e) { dragmove(e); });\r\nwindow.addEventListener('touchmove', function (e) { dragmove(e); });\r\nwindow.addEventListener('mouseup', dragend);\r\nwindow.addEventListener('touchend', dragend);\r\n$('.divider').each((index, divider) => {\r\n    divider.addEventListener('mousedown', function (e) { dragstart(e); });\r\n    divider.addEventListener('touchstart', function (e) { dragstart(e); });\r\n});\r\n\r\nfunction dragstart(e) {\r\n    e.preventDefault();\r\n    dragTarget = e.target;\r\n}\r\n\r\nfunction dragmove(e) {\r\n    if (dragTarget) {\r\n        dragTarget.classList.add('dragged')\r\n        var parent = $(dragTarget).parent()[0];\r\n        var parentStyle = window.getComputedStyle(parent);\r\n        var prev = $(dragTarget).prev('div')[0];\r\n        var next = $(dragTarget).next('div')[0];\r\n        if (dragTarget.classList.contains('vertical')) {\r\n            var parentInnerWidth = parseInt(parentStyle.width, 10) - parseInt(parentStyle.paddingLeft, 10) - parseInt(parentStyle.paddingRight, 10);\r\n            var percentage = ((e.pageX - (parent.getBoundingClientRect().left + parseInt(parentStyle.paddingLeft, 10))) / parentInnerWidth) * 100;\r\n            if (percentage > 5 && percentage < 95) {\r\n                var mainPercentage = 100 - percentage;\r\n                prev.style.width = percentage + '%';\r\n                next.style.width = mainPercentage + '%';\r\n                dragTarget.style.left = 'calc('+ percentage * (parentInnerWidth / parseInt(parentStyle.width, 10)) + '% - 10px - '+ parentStyle.paddingLeft +')';\r\n                next.style.left = 0 + '%';\r\n            }\r\n        } else {\r\n            var parentInnerHeight = parseInt(parentStyle.height, 10) - parseInt(parentStyle.paddingTop, 10) - parseInt(parentStyle.paddingBottom, 10);\r\n            var percentage = ((e.pageY - (parent.getBoundingClientRect().top + parseInt(parentStyle.paddingTop, 10))) / parentInnerHeight) * 100;\r\n            if (percentage > 5 && percentage < 95) {\r\n                var mainPercentage = 100 - percentage;\r\n                prev.style.height = percentage + '%';\r\n                next.style.height = mainPercentage + '%';\r\n                dragTarget.style.top = 'calc('+percentage * (parentInnerHeight / parseInt(parentStyle.height, 10)) + '% - 10px + ' + parentStyle.paddingTop +')';\r\n                next.style.top = 0 + '%';\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction dragend() {\r\n    $('.divider').each((index, divider) => {\r\n        divider.classList.remove('dragged')\r\n    });\r\n    dragTarget = undefined;\r\n}\r\n\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/example/modeler.js b/example/modeler.js
--- a/example/modeler.js	(revision 58c5ef3e9441665e969ebc57e415f508dccebebd)
+++ b/example/modeler.js	(date 1710165995209)
@@ -128,8 +128,8 @@
     __init__ : ['mediator'],
     mediator : ['type', mediator.SpaceModelerHook]
   },
-  // BpmnPropertiesPanelModule,
-  // BpmnPropertiesProviderModule,
+  BpmnPropertiesPanelModule,
+  BpmnPropertiesProviderModule,
   TokenSimulationModule,
   //BpmnColorPickerModule,
   AddExporter,
